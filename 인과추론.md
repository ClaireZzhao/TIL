# 인과 추론
## 실험(A/B 테스트) 없이도 인과 관계와 그 효과를 추정하는 방법

## 인과 추론은 왜 필요할까?
- 비즈니스 환경에서 우리는 고객의 행동을 변화시키기 위한 액션을 수행합니다. 인과 추론은 이러한 "액션"을 중심으로 문제를 정의하고 수치화합니다. 우리가 했던 액션을 평가하고, 새로운 액션을 제안하기 위해 인과 추론이 필요합니다. 
- 우리가 수집하는 데이터는, 관측을 통해 수집한 데이터입니다. 관측을 통해 수집한 데이터에서는 선택 편향이나 인과관계와는 무관한 상관관계가 쉽게 나타날 수 있습니다. 
- 데이터/상황의 특성상 실험이 어렵거나 불가능한 경우가 있기 때문입니다. 
  - 윤리적인 문제가 발생할 수 있는 경우
  - 확보할 수 있는 샘플 수가 적은 경우 
  - 실험대상자가 실험 중이라는 사실을 인지하여 의도적으로 행동하는 경우
  - 실험 과정에서 실험군과 대조군이 서로에게 큰 영향을 주고 받는 경우
  - 비즈니스적으로 리소스/비용 문제가 발생하는 경우

### 예측모형 vs 인과추론
예측모형: 다음달 매출이 얼마나 될까? (뭘 해야 매출이 늘어나는지 알려주지 않는다.)
인과추론: 특정 마케팅 액션을 했을 때 매출 상승에 얼마나 영향을 미칠까?

## 인과 효과를 추정하기 위한 가장 확실하고 정확한 방법은 잘 설계된 실험(A/B 테스트)을 수행하는 겁니다.
RCT에서는 실험 대상자를 실험군과 대조군으로 나눌 때 동전 던지기를 통해 결정합니다. 
- 이렇게 하면 실험 대상자들의 여러 가지 특정이 모두 50:50의 확률로 나누어집니다.
- 결과적으로 실험 대상자의 수가 충분히 많고 동전 던지기가 정말 사람들을 랜덤하게 잘 나누었다면, A그룹과 B그룹은 평균적으로 매우 유사한 그룹이 됩니다.
- 이 상태에서 실험을 진행하면 모든 면에서 동일하자만 테스트하려는 항목만 다른 상태가 됩니다. 이런 조건에서 두 그룹의 수치가 다르다면 이것을 A안과 B안의 차이로 인한 결과로 볼 수 있습니다. 

## 액션의 인과 효과 = [액션을 했을 때의 목표치] - [액션을 하지 않았을 때의 목표치]
그런데, 액션을 했을 때의 목표치와 액션을 하지 않았을 때의 목표치를 동시에 관찰할 수 없으므로 potential outcomes를 통해 인과 효과를 추정할 수 있습니다. 
이 때, 선택 편형을 줄이기 위한 방법으로 자연실험과 준실험이 있습니다. 

## 1. 준실험에 해당하는 방법으로, 편향된 데이터의 밸런스를 맞추는 "매칭" 방법론
선택 편향: 분석 대상이라고 할 수 있는 고객 또는 기업이 어떤 그룹에 속할지 직접 선택하고 있는 상태에서 선택 편향이 발생하니다. 
매칭:
- 각 그룹의 데이터 중 변수들이 평균적으로 유사한 샘플로 매칭하여 인위적으로 유사한 그룹을 만듭니다.
- 두 그룹을 비교했을 때 통계적으로 구분할 수 없는 상태가 되었다면 "비슷한"그룹이라고 볼 수 있습니다.
- 성향 점수(Propensity Score)를 기준으로 비슷한 샘플끼리 매칭하여 선택편향을 줄이는 방법 등 "비슷하다"는 것을 어떻게 정의하는지에 따라 여러 가지 방법론이 있습니다.

## 데이터에 매칭을 적용하는 방법:
- (Step 1) 다른 변수들로 Treatment 여부를 설명하도록 학습해서 0에서 1사이의 값으로 예측한 결과를 성향 점수로 사용합니다.(Logistic Regression 사용)
- (Step 2) Treatment 그룹(액션 대상자)의 데이터와 가장 비슷한 항목을 Control 그룹(액션 대상자가 아닌 사람들)의 데이터에서 찾습니다.(KNN 사용)

## 2. 특정한 이벤트 전후의 효과 비교: Difference in Differences (이중 차분법)
- 특정한 시점에 이벤트나 프로모션 등의 개입이 있었다는 것을 알고 있을 때
- 이벤트의 영향을 받은 그룹과 받지 않은 그룹을 비교하는 방식으로 이벤트의 인과 효과를 찾아냅니다.
- 이벤트 전후의 차이를 한번 구하고, 이벤트의 영향을 받은 곳과 받지 않은 곳의 차이를 비교합니다. 
- 차이 안에서 차이를 한번 더 비교하여 이벤트의 효과를 분리합니다. 
- 전제 조건: 이벤트의 영향을 받은 곳과 받지 않은 곳에서 추이 변화가 비슷한 추세로 나타나야 한다는 조건을 만족해야 올바르게 인과 효과를 추정할 수 있습니다. 

## 3. 특정한 컷오프 점수를 기준으로 액션하는 경우, 해당 액션의 효과를 확인하는 방법
case) 서비스 내에서 활동성이 높은 유저를 타겟으로 푸시 메시지를 보내 구매로 유도하려고 합니다. 활동성을 0~100점 사이로 정의했을 때 80점이 넘은 사람들에게만 푸시 메시지를 보내기로 했습니다. 
이런 상황에서 푸시 메시지가 구매에 미치는 영향이 어떻게 될까요?

문제를 어떻게 접근해보면 좋을까?
- 75 ~ 79점 사이에 분포하는 사람들과 80 ~ 85점 사이에 분포하는 사람들의 특성이 크게 차이가 나지 않는다면, 두 그룹이 푸시받은 이후에 구매전환율에 변화가 있었는지 살펴볼 수 있을 것입니다.
- 푸시 메시지로 인한 영향이 있었다면 80점 부근에서 큰 변환가 있을 것이고, 영향이 없거나 적다면 80점 전후로 큰 차이가 없을 것이라고 예상해 볼 수 있습니다. 

### 이렇게 어떤 변수의 특정한 기준점을 넘었는지 여부를 바탕으로 액션을 하는 상황에서 인과효과를 추정해야 하는 경우 Regression Discontinuity(RD)를 사용할 수 있다.
- 기준점보다 낮은 구간과 높은 구간으로 데이터를 나누어 별개의 모형으로 학습합니다.
- 두 모형을 통해 기준점 부근의 목표 변수 값을 예측합니다. 
- 두 모형의 예측값에 유의미한 차이가 있을 경우, 해당 값을 컷오프로 인한 인과 효과라고 볼 수 있습니다. 
- 전제 조건: 실제 사용자들이 컷오프 기준점을 몰라서 전략적으로 선택할 수 없을 때 즉 컷오프 주위의 데이터는 랜덤하게 선택되는 것을 가정합니다. 
- 전제 조건: 데이터를 컷오프 지점을 기준으로 데이터를 두 그룹으로 나누었을 때, 두 그룹에서 컷오프 주위에 있는 데이터가 가장 비슷한 특성을 가질 것이라고 가정합니다. 

주의할 점:
- 우리가 액션의 기준으로 삼는 변수가 아닌, 다른 변수에 대해서도 컷오프 지점 부근에서 발생하는지 않는지 확인해야 할것
- "컷오프 지점 부근"의 정의에 따라 결과가 달라지는지 확인해야 할것

## 인과 효과를 찾기 위한 가이드라인:
- 강한 상관관계: 상관관계가 약할 때 보다는 강할 때 인과관계가 존재할 가능성이 더 높습니다.
  - 고객들에게 쿠폰을 보냈을 때 매출이 오르는 경향이 강하게 보였습니다. 

- 일관적인 결과(재현성): 분석 대상을 바꿔도 반복적으로 같은 현상이 발생해야 합니다.
  - A그룹에 푸시 메시지를 보내서 구매 전환율이 상승했는데, 이후에 B그룹에 푸시 메시지를 보냈을 때도 구매 전환율이 상승했습니다.

- 구체성: 관계가 구체적일수록, 어떤 요인이 특정한 효과 또는 집단에만 높은 연관성을 보일수록, 인과관계가 존재할 가능성이 더 높습니다. 
  - 특정한 유형의 푸시 메시지를 보낼 때마다 매출에 영향을 미치는 것 같다면, 해당 푸시 메시지로 인한 효과일 가능성이 높습니다.

- 시간적 선후관계: 원인이 결과에 영향을 미치기 위해서는 순서상 먼저 발생해야 합니다.
  - 광고로 인한 매출 영향을 확인하고 있는데 광고가 나가기 전에 매출이 이미 급등했다면 광고로 인한 매출이 올랐다고 보기 어렵습니다.

- 투입-결과 관계: 투입하는 양을 늘릴 수록 결과 변수가 계속 변화하는지 확인해야 합니다.(컷오프 기준으로 인과 효과를 확인하는 상황에서 적용 불가)
  - 광고 예산을 많이 투입할수록 DAU가 증가하고 있다면, 광고가 DAU에 영향을 미치고 있을 가능성이 높습니다.

- 개연성: 결과가 상식에 부합하거나, 기존의 지식을 통해 충분히 설명할 수 있어야 합니다. 

- 실험에 의한 결과: 무작위 통제 실험을 기반으로 하는 결과는 인과 관계일 가능성이 높습니다.

- 기존 인과관계와의 유사성: 기존에 이미 인과관계가 있다고 판명된 사례와 비슷한 구조를 가지는 상황이라면, 인과 관계일 가능성이 높습니다. 



